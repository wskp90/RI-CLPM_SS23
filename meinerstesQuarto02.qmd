---
title: "mein erstes Doc"
author: "Name"
format: docx
editor: source
execute: 
  echo: false
  eval: true
  warning: false
editor_options:
  chunk_output_type: console
toc: true
---

# Vorbereitung
## Pakete laden
```{r}
rm(list= ls()) # start clean ####
if (!require("pacman")) install.packages("pacman")
pacman::p_load(sjlabelled,foreign,tidyverse,sjmisc,Hmisc,panelr,gt,gtExtras,gtsummary,
               here,fs,usethis,labelled,janitor,magrittr,qs,tictoc,plm,
               psych,easystats,irr,lavaan,semTools,semPlot,broom,tidySEM)
```

## Daten laden
```{r}
orgdat = qread(paste0(Sys.getenv("FAUBOX"),"/GLES/za6838/za6838_7729.qs"))
```

## Variablen
```{r}
semdat = orgdat %>%
  select(ends_with(c("_1290","_160p")) & starts_with(c("kp10","kp12","kp14")))

```

## Long-Datensatz erzeugen
```{r}
# semdat_panel = orgdat %>% 
#   select(starts_with(c("kp10","kp12","kp14","kp15","kp16")) & ends_with(c("_1290","_160p","_1500"))) %>% 
#   mutate(across(everything(), ~rec(., rec = "-99,-95,-93,-71=NA;else = copy"))) %>% 
#   long_panel(., prefix = "kp", suffix = "_", periods = c("10","12","14","15","16"), label_location = "beginning")
# names(semdat_panel) = c("id","welle","klima","trust","lire")
```


## Recodieren
```{r}
semdat %<>% mutate(across(everything(), ~rec(., rec = "-99,-98,-95,-93,-92=NA;else = copy")))
```

# Output erzeugen
## HÃ¤ufigkeiten
```{r}
semdat %>% select("kp10_160p") %>% frq(.,show.na = F) %>% as.data.frame() %>% gt %>% gt_theme_nytimes()
```

## Korrelation
```{r}
#| fig-width: 10
semdat %>% 
  psych::cor.plot(.,stars = T)
```


## ICC-Koeffizienten
```{r}
semdat %>% 
  select(contains("_160p")) %>% irr::icc()
```

```{r}
clpm <-
'
#Resiudal Correlation
x1 ~~ co01*y1
x2 ~~ co02*y2
x3 ~~ co03*y3

#Stability & Crosslagged Paths
x2 ~ co05*x1 + co09*y1
x3 ~ co06*x2 + co10*y2
y2 ~ co07*y1 + co11*x1
y3 ~ co08*y2 + co12*x2'
```

```{r}
semdat %<>% rename(x1 = kp10_160p, x2 = kp12_160p, x3 = kp14_160p,
                  y1 = kp10_1290, y2 = kp12_1290, y3 = kp14_1290)

```

```{r}
cl1 <- sem(clpm, data=semdat, missing="ML", estimator = "MLR",mimic="Mplus", meanstructure = T)

```
```{r}
broom::glance(cl1) %>% select(c(cfi,tli,agfi,rmsea,srmr)) %>% 
  gt %>%
  fmt_number(decimals = 3, columns = c(cfi,tli,agfi,rmsea,srmr)) %>% gt_theme_nytimes()

broom::tidy(cl1) %>% filter(., op =="~") %>% select(., c(term, op, estimate,std.error,p.value,std.all)) %>% 
  gt %>% 
  fmt_number(decimals = 2, columns = c(estimate,std.error,std.all)) %>% fmt_number(decimals = 3, columns = p.value)
```

